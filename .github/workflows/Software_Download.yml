name: Software Download link

on:
  workflow_dispatch:
  # 增加定时任务触发
  schedule:
    - cron: '0 0 * * *'  # 每天凌晨执行一次

jobs:
  build:
    name: Software Download link
    runs-on: ubuntu-latest
    env:
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_ID: ${{ secrets.TELEGRAM_ID }}
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests  # 安装所需的依赖包
      - name: Run Python script
        run: |
          python ./python/python.py
       
      - name: Commit and push changes
        run: |
            git config --local user.email ${{ secrets.TELEGRAM_EMAIL }}
            git config --local user.name ${{ secrets.TELEGRAM_NAME }}
            git pull
            git add ./config/id.json ./config/telegram_id.json
            git commit -m "更新id版本"
            git push
      - name: 删除
        shell: bash
        run: |
              current_run_id=$(echo "$GITHUB_RUN_ID")
              runs=$(curl -s -X GET "https://api.github.com/repos/${{ github.repository }}/actions/workflows/my.yml/runs" \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" | jq -r '.workflow_runs[].id')
              echo "$runs"
                  keep_runs=$(echo "$runs" | head -n 5)
                  for run_id in $runs; do
                    if [ "$run_id" != "$current_run_id" ] && [[ ! "$keep_runs" =~ "$run_id" ]]; then
                      curl -s -X DELETE "https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id" \
                        -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                        -H "Accept: application/vnd.github.v3+json" > /dev/null
                    fi
                  done